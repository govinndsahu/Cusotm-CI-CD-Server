projects:
  - name: "StorageApp-Backend"
    environments:
      - branch: "main"
        env_name: "PROD"
        commands:
          run: |
            # Setup SSH key and known_hosts
            # Add server host key so SSH does not ask for confirmation
            ssh-keyscan -H "${SSH_HOST}" >> ~/.ssh/known_hosts

            ssh -i "${SSH_SECRET_KEY_PATH}" "${SSH_USER}"@"${SSH_HOST}" "bash" << 'EOF'
            set -e

            ROOT_PATH=$"/home/ubuntu/apps/production-apps/storageApp/backend"

            cd "$ROOT_PATH/releases"

            mkdir "${NEW_RELEASE}"

            cd "./${NEW_RELEASE}"

            git clone -b develop "${CLONE_URL}" .

            sudo ln -sf "$ROOT_PATH/.env" .env

            npm ci 

            cd "$ROOT_PATH"

            sudo ln -sfn "$ROOT_PATH/releases/${NEW_RELEASE}" current

            pm2 reload ecosystem.config.js
            EOF
        rollback:
          run: |
            # Setup SSH key and known_hosts
            # Add server host key so SSH does not ask for confirmation
            ssh-keyscan -H "${SSH_HOST}" >> ~/.ssh/known_hosts

            ssh -i "${SSH_SECRET_KEY_PATH}" "${SSH_USER}"@"${SSH_HOST}" "bash" << 'EOF'

            set -e

            cd /home/ubuntu/apps/production-apps/storageApp/backend

            # Find the folder name that contains the previous SHA
            PREV_FOLDER=$(ls releases | grep "${PREVIOUS_RELEASE}")

            echo "Rolling back to: $PREV_FOLDER"

            # Atomic Swap
            sudo ln -sfn "./releases/$PREV_FOLDER" current

            # Reload to pick up the old code
            pm2 reload ecosystem.config.js
            EOF
        cleanup:
          run: |
            # Setup SSH key and known_hosts
            # Add server host key so SSH does not ask for confirmation
            ssh-keyscan -H "${SSH_HOST}" >> ~/.ssh/known_hosts

            ssh -i "${SSH_SECRET_KEY_PATH}" "${SSH_USER}"@"${SSH_HOST}" "bash" << 'EOF'

            set -e

            cd /home/ubuntu/apps/production-apps/storageApp/backend/releases

            ls -1t | tail -n +3 | xargs -I {} rm -rf "{}"
            EOF

      - branch: "develop"
        env_name: "TEST"
        commands:
          run: |
            # Setup SSH key and known_hosts
            # Add server host key so SSH does not ask for confirmation
            ssh-keyscan -H "${SSH_HOST}" >> ~/.ssh/known_hosts

            ssh -i "${SSH_SECRET_KEY_PATH}" "${SSH_USER}"@"${SSH_HOST}" "bash" << 'EOF'
            set -e

            ROOT_PATH=$"/home/ubuntu/apps/test-apps/storageApp/backend"

            cd "$ROOT_PATH/releases"

            mkdir "${NEW_RELEASE}"

            cd "./${NEW_RELEASE}"

            git clone -b develop "${CLONE_URL}" .

            sudo ln -sf "$ROOT_PATH/.env" .env

            npm ci 

            cd "$ROOT_PATH"

            sudo ln -sfn "$ROOT_PATH/releases/${NEW_RELEASE}" current

            pm2 reload ecosystem.config.js
            EOF
        rollback:
          run: |
            # Setup SSH key and known_hosts
            # Add server host key so SSH does not ask for confirmation
            ssh-keyscan -H "${SSH_HOST}" >> ~/.ssh/known_hosts

            ssh -i "${SSH_SECRET_KEY_PATH}" "${SSH_USER}"@"${SSH_HOST}" "bash" << 'EOF'

            set -e

            cd /home/ubuntu/apps/test-apps/storageApp/backend

            # Find the folder name that contains the previous SHA
            PREV_FOLDER=$(ls releases | grep "${PREVIOUS_RELEASE}")

            echo "Rolling back to: $PREV_FOLDER"

            # Atomic Swap
            sudo ln -sfn "./releases/$PREV_FOLDER" current

            # Reload to pick up the old code
            pm2 reload ecosystem.config.js
            EOF
        cleanup:
          run: |
            # Setup SSH key and known_hosts
            # Add server host key so SSH does not ask for confirmation
            ssh-keyscan -H "${SSH_HOST}" >> ~/.ssh/known_hosts

            ssh -i "${SSH_SECRET_KEY_PATH}" "${SSH_USER}"@"${SSH_HOST}" "bash" << 'EOF'

            set -e

            echo "cleaning disk..."

            cd /home/ubuntu/apps/test-apps/storageApp/backend/releases

            ls -1t | tail -n +3 | xargs -I {} rm -rf "{}"

            echo "Execution completed thoroughly."
            EOF

  - name: "StorageApp-Frotend"
    environments:
      - branch: "main"
        env_name: "PROD"
        commands:
          run: |
            # commands

      - branch: "develop"
        env_name: "TEST"
        commands:
          run: |
            # commands
